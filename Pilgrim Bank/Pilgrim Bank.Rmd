---
title: "Pilgrim Bank"
author: "Luca Bajardi e Francesca Collini"
date: "31/07/2020"
output:
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Carichiamo i dati leggendo il file csv e settiamo il seme del generatore pseudo-casuale così da avere i risultati sempre uguali.
```{r read}
rm(list =ls())
set.seed(1)
Pilgrim = read.csv(file = "PilgrimABC.csv", header=T)
attach(Pilgrim)
```

Osserviamo che il nostro dataset contiene 31634 osservazioni e 11 variabili (le ultime due non sono interessanti ai fini della nostra analisi). I dati sono relativi a due anni, 1999 e 2000, per ciascuno abbiamo a disposizione un'informazione relativa al profitto (o alla perdita) di un determinato cliente in quell'anno e un'informazione che ci dice se quel cliente in quell'anno ha utilizzato l'opzione di online banking oppure no: la variabile Online quindi è una variabile binaria. Abbiamo poi a dispozione altre informazioni relative al cliente:

* AGE: variabile categorica che indica a che fascia  di età appartiene il cliente (1 = less than 15 years; 2 = 15-24 years; 3 = 25-34 years; 4 = 35-44 years; 5 = 45-54 years; 6 = 55-64 years; 7 = 65 years and older.)

* INCOME: variabile categorica che indica il range del reddito di ciascun cliente (1 = less than $\$15,000; 2 = \$15,000-\$19,999; 3 = \$20,000-\$29,999; 4 = \$30,000-\$39,999; 5 = \$40,000- \$49,999; 6 = \$50,000-\$74,999; 7 = \$75,000-\$99,999; 8 = \$100,000-\$124,999; 9 = \$125,000$ and more.)

* TENURE: rappresenta l'età di servizio

* DISTRICT: variabile categorica che indica uno delle tre regioni geografiche in cui si trova il cliente.
```{r esplorazione}
dim(Pilgrim)
names(Pilgrim[, 1:9])
```
Rinominiamo le colonne per evitare problemi con i nomi:
```{r rinomino_colonne}
Profit=Pilgrim$X9Profit
Online=Pilgrim$X9Online
Age=Pilgrim$X9Age
Income=Pilgrim$X9Inc
Tenure=Pilgrim$X9Tenure
District=Pilgrim$X9District
```

```{r dataset}
head(Pilgrim)
```

Dal summary del profitto possiamo facilmente osservare che la distribuzione è molto asimmetrica perchè media e mediana sono molto diverse tra loro. Inoltre notiamo che tutto il primo quartile è negativo.
```{r summary profit}
summary(Profit)
```
Dall'istogramma sul profitto nel 1999 possiamo notare che c'è un discreto numero di clienti che mi fa perdere e che l'istogramma è molto scodato a destra quindi ci sono pochissimi clienti che mi fanno guadagnare molto.
```{r hist profit}
hist(Profit)
```
Possiamo notare che ci sono 16832 clienti che generano profitto sulle 31634 presenti nel dataset.
```{r profitable}
N=length(Profit)
Nprofitable = sum(Profit>0)
cat('profitable = ', Nprofitable, ' out of ', N, '\n')
```
Tramite la curva di Pareto possiamo confermare che poche persone fanno guadagnare tanto, mentre la maggior parte delle persone fa guadagnare poco o addirittura fa perdere guadagno.
```{r Pareto curve}
cumprofit=cumsum(sort(Profit,decreasing=TRUE))*100/sum(Profit)
plot(100*(1:N)/N,cumprofit,type='l')
grid()
```

Dall'analisi dei profitti medi possiamo notare che il profitto generato da chi utilizza i servizi online è maggiore rispetto a chi li utilizza offline.
```{r mean profits}
cat('average profit ', mean(Profit), '\n')
ProfitOnline = Profit[Online==1]
cat('average profit ON', mean(ProfitOnline), '\n')
ProfitOffline = Profit[Online==0]
cat('average profit OFF', mean(ProfitOffline), '\n')
```
Quello che vorremmo capire è se questa differenza è stocasticamente significativa, quindi se davvero coloro che utilizzano i servizi online mi permettono di guadagnare di più. Per questo motivo possiamo eseguire un `t.test` sulle due popolazioni, i clienti che utilizzano il servizio online e coloro che non lo usano, e vado a vedere quanto vale il p-value. L'ipotesi nulla in questo caso è che le medie siano uguali e che quindi la differenza tra le medie delle due popolazioni non sia significativa.
\textcolor{red}{Analizziamo inoltre l'intervallo di confidenza per vedere se i dati sono sufficienti o no. Infatti se intervallo fosse troppo grande vorrebbe dire che avrei bisogno di più clienti per formulare una teoria generale.}
```{r int.conf}
cat('Conf int profit ', t.test(Profit)$conf.int, '\n')
cat('p-value difference ',t.test(ProfitOnline,ProfitOffline)$p.value, '\n')
```
Risulta esserci una differenza di circa 6 dollari tra le due popolazioni, quindi non risulta più di tanto significtiva dal lato business, ma anche il p-value è maggiore di 0.05 e quindi possiamo concludere che questa differenza non è significativa nemmeno dal punto di vista statistico, e quindi non rifiutiamo l'ipotesi nulla sulla differenza tra le medie.

Possiamo ottenere lo stesso risultato impostando il modello di regressione classico:
```{r lm_online}
mod = lm(Profit ~ Online)
summary(mod)
```
Dal summary del modello, possiamo osservare che il valore dell'intercetta è la media del profitto tra coloro che operano offline e il valore aggiunto di quelli che operano online è di quasi 6 dollari come la differenza tra la media di quelli che operano online e la media di quelli che operano offline. Anche in questo caso però, il p-value è superiore a 0.05 come in precedenza. Questo significa che la variabile Online non è significativa. Tuttavia, questo potrebbe essere dovuto al fatto che stiamo mettendo insieme clienti molto diversi tra loro e quindi considerando un unico modello non riusciamo a distinguere bene i singoli effetti. Per questo introduciamo l'età nel modello di regressione.

La variabile `Age` è riconosciuta numerica anche se in realtà è categorica. Nell'analisi dovremo trasformarla in `factor` perché altrimenti vi è troppa influenza dell'ordinamento delle variabili categoriali.

```{r age factor}
Age1 = as.factor(Age)
summary(Age1)
```
Possiamo notare che ci sono 8289 osservazioni in cui non è presente l'età, infatti nel `summary` sottostante possiamo notare che nonostante ci siano 32 mila osservazioni ci sono solo 23 mila gradi di libertà in quanto quelle con i missing values sono eliminate automaticamente.
```{r lm_onlineAge1}
mod = lm(Profit ~ Online+Age1)
summary(mod)
```
Ora sulle fasce d'età vi è una significatività sia statistica che di business, infatti le diverse età potrebbero implicare diversi redditi, in linea generale un giovane tende ad usare di più l'online banking ma ha un reddito minore e quindi fa guadagnare di meno.

Posso notare che a prescindere dall'utilizzo dell'online o dell'offline i giovani sono meno profittevoli degli anziani:
```{r check profitability}
lapply(split(Profit,as.factor(Age)),mean) 
```
Inoltre il $20\%$ dei giovani usa l'online, questa percentuale scende per le fasce di età successive fino ad arrivare a poco più del $3\%$.
```{r lm_onlineAge3}
lapply(split(Online,as.factor(Age)),mean)
```

Ci potrebbe essere un bias dovuto ai dati mancanti. Infatti ci sono molte osservazioni in cui non abbiamo l'informazione sull'età. Non sappiamo perchè questi dati sono mancanti, anche se è difficile pensare che sia semplicemente dovuto a delle dimenticanze o sviste in fase di racconta dei dati, forse avrebbe più senso pensare ai conti cointestati oppure al fatto che il conto venga intestato ad una società. 
```{r lm_onlineAgeGiven}
sum(is.na(Age))
AgeGiven = ifelse(is.na(Age),0,1) # 0 dove c'è NA, 1 se c'è l'età
mod = lm(Profit ~ AgeGiven)
summary(mod)
```
C'è una differenza statisticamente significativa sul profitto tra  le osservazioni in cui è presente l'informazione sull'età e dove non c'è. La variabile `AgeGiven` infatti risulta significativa, la distribuzione tra le due popolazioni di conseguenza non risulta omogenea. Quindi, eliminando i dati dove manca l'età, stiamo distorcendo l'analisi, perchè queste medie sono "sporcate". Infatti c'è una profittabilità media più alta tra chi mi ha dato l'età rispetto a chi non me l'ha data.

\textcolor{red}{LUCA SI è FERMATO QUA}
 Possiamo provare diversi metodi per cercare di recuperare quelle osservazioni dove l'età non è presente, in modo da includerle comunque nell'analisi. Se avessimo delle righe complete ed alcune con un solo campo mancante, potremmo costruire un modello di regressione in modo da prevedere qeul valore. Una possibile alternativa, più immediata, è quella di sostituire i valori mancanti con i valori nulli. Questa strada sembra abbastanza convincente, quando l'età è una variabile categorica e possiamo quindi scegliere un valore arbitrario. Quando invece la variabile è numerica non ha molto senso, perchè equivale a dire che coloro che non hanno fornito l'età, risultano neonati.
```{r lm_onlineAge4}
AgeZero = ifelse(is.na(Age),0,Age) 
table(AgeZero)
```
```{r lm_AgeZero}
mod = lm(Profit ~ Online+AgeZero)
summary(mod)
```
I valori dei coefficienti sono dovuti al fatto che in modo arbitrario abbiamo scelto di sostituire i valori  mancanti con il valore nullo.
# Replace missing with mean
Una possibile alternativa è quella di sostituire i valori mancanti con la media dell'età calcolata sui valori presenti.
```{r AgeAverage}
mm = mean(Age, na.rm=TRUE)#non consideriamo i valori mancanti
AgeAverage = ifelse(is.na(Age),mm,Age)
table(AgeAverage)
```
```{r lm_AgeAverage}
mod = lm(Profit ~ Online+AgeAverage)
summary(mod)
```

Ovviamente osserviamo che i valori dei coefficienti cambiano, ed in aprticolare cambia il contributo della variabile Online, quindi a seconda di come tappo il buco, di come scelgo di inserire i valori mancanti nel modello, otteniamo un risultato diverso. Questo ci suggerisce che probabilmente, non è questa la strada giusta per procedere.

```{r lm_AgeZero+Given}
mod = lm(Profit ~ Online+AgeZero+AgeGiven)
summary(mod)
```

Per tentare di evitare questo problema potremmo  considerare i modelli ottenuti tenendo conto sia della variabile Age opportunamente modificata, sia del fatto che la variabile Age venga fornita oppure no. Questo ci permette di considerare una variabile categorica che indica la presenza o meno dell'informazione sull'età, quindi non importa più di tanto come vado a rimepire il buco dell'informazione mancante.
```{r lm_AgeAverage+Given}
mod = lm(Profit ~ Online+AgeAverage+AgeGiven)
summary(mod)
```
Osserviamo che in entrambi i casi, tutte le variabili risultano significative perchè il p-value corrispondente è sufficientemente piccolo. Inoltre il valore della variabile Online è lo stesso del caso precedente anche se abbiamo scelto di tappare i buchi scegliendo dei valori arbitrari. Tuttavia il valore dell'$R^2$ risulta essere molto molto piccolo, quindi questo modello povero arriva a spiegare circa il $2.5\%$ della variabilità. 

Per cercare un modello più valido, possiamo considerare un'altra variabile, ad esempio il reddito di ciascun cliente. Anche in questo caso possiamo scegliere come includere i valori NA, scegliamo ad esempio i valori nulli.
```{r lm_IncomeZero}
IncomeZero = ifelse(is.na(Income),0,Income)
IncomeGiven = ifelse(is.na(Income),0,1)
mod = lm(Profit ~ Online+AgeAverage+AgeGiven+IncomeZero+IncomeGiven)
summary(mod)
```
Possiamo notare, che il valore della variabile Online scende un po'e che  l'$R^2$ è quasi raddoppiato, ma rimane comunque piccolo.

Notiamo che non ci sono valori mancanti nella variabile District, tuttavia viene considerata numerica, quindi vorremmo trasformarla in categorica, in modo che ogni valore venga associato ad uno dei tre distretti. Quello che possiamo fare è introdurre due variabili binarie che rappresentano i distretti. Notiamo inoltre che non ci sono valori mancanti neanche nella variabile Tenure.
```{r district}
# Control for Tenure and district
any(is.na(District))
table(District) 
District1100 = ifelse(District==1100,1,0)
District1200 = ifelse(District==1200,1,0)
any(is.na(Tenure))
```
Andando ad effettuare la regressione con tutte queste variabili, notiamo che l'$R^2$ (e anche l'$R_{adj}^2$) sta aumentando anche se sempre di poco, mentre il contributo della variabile Online adesso vale circa 13.
```{r regressione completa}
mod = lm(Profit ~ Online+AgeAverage+AgeGiven+IncomeZero+IncomeGiven+Tenure+District1100+District1200)
summary(mod)
```

#potremmo considerare Age come categorico
```{r AgeCat}
AgeCat = ifelse(is.na(Age)==TRUE,0,Age)
Age1=as.factor(AgeCat)
levels(Age1)
```
```{r lm_onlineAge5}
mod = lm(Profit ~ Online+Age1+IncomeZero+IncomeGiven+Tenure+District1100+District1200)
summary(mod)
```
#potremmo considerare il rapporto tra Online e Age
```{r lm_onlineAge6}

```






```{r lm_onlineAge7}

```

```{r lm_onlineAge8}

```

```{r lm_onlineAge9}

```

```{r lm_Age}

```


# PARTE B
In conclusione, i modelli trovati sono poco utili nella previsione del profitto. Possiamo provare a migliorare la situazione, utilizzando la storia della banca, e quindi anche le informazioni passate dei clienti.
```{r parte b}
#Andiamo a rinominare le variabili
Profit9=X9Profit 
Online9=X9Online
Profit0=X0Profit
Online0=X0Online
```

## Modello base
Proviamo a prevedere il profitto di ciascun cliente nel 2000, andando ad utilizzare l'informazione binaria rigaurdo all'uso dell'online banking. L'$R^2$ è troppo basso, quindi vorremmo migliorare questo modello.
```{r mod1}
mod1 = lm(Profit0 ~ Online9)
summary(mod1)
```

Per provare a far aumentare il valore dell'$R^2$, possiamo utilizzare le informazioni anagrafiche a nostra disposizione relative al singolo cliente, quelle che abbiamo utilizzato nei modelli precedenti.

```{r mod2}
mod2 = lm(Profit0 ~ Online9+AgeZero+AgeGiven+IncomeZero+IncomeGiven+Tenure+District1100+District1200)
summary(mod2)
```
Questo migliora abbastanza le prestazioni, perchè così riusciamo a spiegare molta più della variabilità presente. Inoltre, abbiamo un'ulteriore informazione sui singoli clienti: il profitto nel 1999. Inserendo questa informazione nel modello è come se dicessimo che il profitto nell'anno successivo dipende dal profitto dell'anno in corso e dalle caratteristiche del singolo cliente. Quindi in linea di principio, coloro che l'anno precdente mi hanno fatto guadagnare, continueranno a farmi guadagnare anche nell'anno successivo. 
```{r mod3}
mod3 = lm(Profit0 ~ Profit9+Online9+AgeZero+AgeGiven+IncomeZero+IncomeGiven+Tenure+District1100+District1200)
summary(mod3)
```
Adesso l'$R^2$ risulta notevolmente migliorato: riusciamo a spiegare oltre il $36\%$ della variabilità.

Possiamo anche supporre che i dati anagrafici non siano rilevanti, ma magari non li abbiamo utilizzati nel modo giusto nel modello. Infatti provando a tenere la variabile del profitto precedente come regressore, ma eliminando le variabili `Age` e `Income`, otteniamo un modello che spiega all'incirca la stessa variabilità.

```{r mod4}
mod4 = lm(Profit0 ~ Profit9+Online9+Tenure+District1100+District1200)
summary(mod4)
```

## Profitto nel tempo

Quello che possiamo osservare è come le due variabili legate al profitto del singolo cliente nei diversi anni, siano correlate tra loro. Osserviamo infatti che c'è una correlazione di circa il $60\%$. Sono presenti inoltre solamente 8 osservazioni in cui il profitto nel 2000 risulta essere maggiore di 5000, quindi possiamo pensare che quelle osservazioni siano degli outliers.
```{r profit}
plot(Profit9,Profit0)
cor(Profit9,Profit0,use="complete.obs")
sum(Profit0>5000,na.rm=TRUE)
```
Quello che possiamo fare è andare ad osservare il valore dell'$R^2$ nel caso in cui questi valori vengano eliminati, per capire se il modello risulta migliore.
```{r outliers}
c=which(Profit0>5000)
detach(Pilgrim)
data=Pilgrim[-c,]
attach(data)
Out_Profit9=X9Profit
Out_Online9=X9Online
Out_Age=X9Age
Out_Income=X9Inc
Out_Tenure=X9Tenure
Out_District=X9District
Out_Profit0=X0Profit
Out_Online0=X0Online
Out_District1100 = ifelse(Out_District==1100,1,0)
Out_District1200 = ifelse(Out_District==1200,1,0)
Out_AgeGiven = ifelse(is.na(Out_Age),0,1)
Out_AgeZero = ifelse(is.na(Out_Age),0,Out_Age)
Out_IncomeZero = ifelse(is.na(Out_Income),0,Out_Income)
Out_IncomeGiven = ifelse(is.na(Out_Income),0,1)
mod3 = lm(Out_Profit0 ~ Out_Profit9+Out_Online9+Out_AgeZero+Out_AgeGiven+Out_IncomeZero+Out_IncomeGiven+Out_Tenure+Out_District1100+Out_District1200)
summary(mod3)
mod4 = lm(Out_Profit0 ~ Out_Profit9+Out_Online9+Out_Tenure+Out_District1100+Out_District1200)
summary(mod4)
detach(data)
attach(Pilgrim)
```
Quindi andando a ripetere il codice precedente, quando però eliminiamo gli outliers, miglioriamo l'$R^2$ che negli ultimi due modelli raggiunge circa il $50\%$. 

Osserviamo inoltre che abbiamo un numero diverso di valori mancanti: ci sono 5219 osservazioni in cui non abbiamo l'informazione sulla online banking nel 2000 e 5238 osservazioni in cui non abbiamo l'informazione sul profitto nel 2000, questo vuol dire che il cliente non è rimasto nella banca nell'anno successivo. Quindi logicamente, non ci sono osservazioni in cui abbiamo l'informazione di Profit0 ma non di Online0. Ci sono invece 19 osservazioni in cui al contrario abbiamo l'informazione sul profitto, ma non sappiamo se il cliente ha utilizzato la banca online.
```{r na}
sum(is.na(Online0))
sum(is.na(Profit0))
which(is.na(Profit0) != is.na(Online0))
which(is.na(Profit0) < is.na(Online0))
which(is.na(Profit0) > is.na(Online0))
```
### ADD retain variable
Quello che possiamo fare è aggiungere una variabile aggiuntiva `Retain` che ci dice se il cliente rimane nella banca anche nell'anno successivo. A questo punto vorremmo capire come prevedere al meglio se un cliente rimane con la banca nell'anno successivo oppure no, questo potrebbe dipendere da tutte le caratteristiche del cliente.
```{r retain}
Retain = ifelse(is.na(Profit0),0,1)
mod1 = lm(Retain ~ Online9)
summary(mod1)
mod2 = lm(Retain ~ Online9+AgeZero+AgeGiven+IncomeZero+IncomeGiven+Tenure+District1100+District1200)
summary(mod2)
mod3 = lm(Retain ~ Profit9+Online9+AgeZero+AgeGiven+IncomeZero+IncomeGiven+Tenure+District1100+District1200)
summary(mod3)
hist(mod3$fitted,nclass=50, main ="Histogrm of mod3")
```
Andare a considerare il valore dell'$R^2$ per valtutare la bontà del modello non è molto opportuno perchè stiamo prevedendo se il cliente rimane oppure no, quindi è una variabile binaria. Dall'istogramma possiamo facilmente dedurre ci sono due gruppi abbastanza distinti, quindi quello che possiamo fare è fissare una certa soglia al di sopra della quale possiamo concludere che il cliente è sicuro, mentre al di sotto si trovano quei clienti che probabilmente il prossimo anno cambieranno la banca. Infatti ci sono due mode molto alte e sufficientemente lontane, mentre tra i valori di 0.7 e 0.8, troviamo una "zona grigia", dove la moda è molto bassa e i clienti sono abbastanza incerti. Inoltre saremmo interessati ad interpretare i valori dell'istogramma come delle probabilità, anche se ci sono dei valori più grandi di 1. In questo modo sarei in grado di capire sotto quale valore dovrei preoccuparmi del cliente.

#--- PART 3 - ANALYZE retention with Logistic regression
Proviamo a prevedere il comportamento futuro di un cliente, utilizzando la regressione logistica.
```{r logistic}
glm.out = glm(Retain ~ Profit9+Online9+AgeZero+AgeGiven+IncomeZero+
  IncomeGiven+Tenure+District1100+District1200,family=binomial(logit))
summary(glm.out)
hist(glm.out$fitted.values,nclass=50, main="Histogram of Logistic Regression")
```
Questo metodo risulta molto veloce,in quanto si ferma dopo solo 5 iterazioni. Inoltre le diasgnostiche del modello sono un po' diverse, notiamo che non abbiamo più a disposizione l'$R^2$,ma non cambia il senso generale, come osserviamo dall'istogramma.
```{r confronto}
plot(mod3$fitted, glm.out$fitted, xlab="Predicted OLS", ylab="Predicted logit")
```
# Regressione logistica andando ad eliminare gli outliers
```{r logistic no out}
glm.out = glm(Retain ~ Profit9+Online9+AgeZero+AgeGiven+IncomeZero+
  IncomeGiven+Tenure+District1100+District1200,family=binomial(logit))
summary(glm.out)
hist(glm.out$fitted.values,nclass=50, main="Histogram of Logistic Regression")
```
#--- PART 4 - Demographics vs. Past profit to analyze profitability
Possiamo considerare le variabili `Age` e `Income` effettivamente come categoriche.
```{r completo categorico}
mod1 = lm(Profit0 ~ 
  Profit9+Online9+Tenure+District1100+District1200+factor(Age)+factor(Income))
summary(mod1)
```

```{r no Age ne Income}
mod2 = lm(Profit0 ~ Profit9+Online9+Tenure)
summary(mod2)
```

```{r categorico+district}
mod3 = lm(Profit0 ~ District1100+District1200+factor(Age)+factor(Income))
summary(mod3)
```


```{r Profit0}
summary(Profit0)
plot(Profit0)
m=which(Profit0<=-5000)
M=which(Profit0>=5000)
d=Pilgrim[-m,]
dtab=d[-M, ]
summary(dtab)
```

```{r logistic2}
glm.out = glm(Retain ~ Profit9+Online9+AgeZero+AgeGiven+IncomeZero+
  IncomeGiven+Tenure+District1100+District1200,family=binomial(logit))
summary(glm.out)
hist(glm.out$fitted.values,nclass=50, main="Histogram of Logistic Regression")
```

```{r decision tree}
library(tree)
h.tree<-tree(as.factor(Retain) ~ Profit9+Online9+AgeZero+AgeGiven+IncomeZero+
  IncomeGiven+Tenure+District1100+District1200)
summary(h.tree)
```

```{r decision tree2}
plot(h.tree,lwd=3)
text(h.tree,pretty=0,cex=1.2,col="blue")
h.tree
setup<-tree.control(length(Retain), mincut = 2, minsize = 6, mindev = 0.0005)
h.tree<-tree(as.factor(Retain) ~ Profit9+Online9+AgeZero+AgeGiven+IncomeZero+
  IncomeGiven+Tenure+District1100+District1200,control=setup)
summary(h.tree)
plot(h.tree,lwd=3)
text(h.tree,pretty=0,cex=1.2,col="blue")
```

```{r decision tree cv}
cv.hitters =cv.tree(h.tree)# ,FUN=prune.tree )
cv.hitters
plot(cv.hitters$size,cv.hitters$dev,type="b", lwd=3,col="blue",
xlab="Nodi terminali", ylab="RSS",main="Cost complexity pruning" )
```

```{r decision tree predict}
prune.hitters=prune.tree(h.tree, best =10)
plot(prune.hitters,lwd=3)
text(prune.hitters ,pretty =0,cex=1.2,col="blue")
P1<-predict(prune.hitters)
P1<-data.frame(P1) ## semplicemente per osservare meglio
## cosa abbiamo nell'oggetto P1
head(P1)
```

```{r decision tree balanced}
library(rpart)
library(ROSE)
Retain = as.factor(Retain)
data_balanced_over <- ovun.sample(as.factor(Retain) ~ Profit9+Online9+AgeZero+AgeGiven+IncomeZero+IncomeGiven+Tenure+District1100+District1200, method = "over",N = 52792)$data
setup<-tree.control(52792, mincut = 2, minsize = 6, mindev = 0.00003)
h.tree.balanced<-rpart(Retain ~ Profit9+Online9+AgeZero+AgeGiven+IncomeZero+IncomeGiven+Tenure+District1100+District1200, data=data_balanced_over, control=setup)
summary(h.tree.balanced)
plot(h.tree.balanced,lwd=3)
text(h.tree.balanced,pretty=0,cex=1.2,col="blue")
pred.treebal <- predict(h.tree.balanced, newdata = data_balanced_over)


#summary(as.factor(Retain))
#data_balanced_over <- ovun.sample(as.factor(Retain) ~ Profit9+Online9+AgeZero+AgeGiven+IncomeZero+
#  IncomeGiven+Tenure+District1100+District1200, method = "over",N = 5000)$data
#table(data_balanced_over$Retain)
```

```{r detach}
detach(Pilgrim)
```
